name: publish

on:
  push:
    tags:
      - "v*"

jobs:
  ci-linux:
    uses: ./.github/workflows/ci-linux.yml

  publish:
    needs: [ci-linux]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify tag matches package.json version
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          PKG=$(node -p "require('./package.json').version")
          if [ "$TAG" != "$PKG" ]; then
            echo "Tag version ($TAG) does not match package.json version ($PKG)"
            exit 1
          fi

      - name: Verify all expected tarballs exist
        run: |
          EXPECTED_PLATFORMS="linux-x64-cpu"
          MISSING=0
          for TRIPLE in $EXPECTED_PLATFORMS; do
            TARBALL="artifacts/${TRIPLE}/node-whisper-cpp-${TRIPLE}.tgz"
            if [ ! -f "$TARBALL" ]; then
              echo "Missing platform tarball: $TARBALL"
              MISSING=1
            fi
            MAIN="artifacts/${TRIPLE}/node-whisper-cpp.tgz"
            if [ ! -f "$MAIN" ]; then
              echo "Missing main tarball in: $MAIN"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then
            echo "Not all expected tarballs are present, aborting publish"
            exit 1
          fi
          echo "All tarballs verified"

      - name: Publish platform packages
        run: |
          for dir in artifacts/*/; do
            TRIPLE=$(basename "$dir")
            TARBALL="artifacts/${TRIPLE}/node-whisper-cpp-${TRIPLE}.tgz"
            if [ -f "$TARBALL" ]; then
              echo "Publishing @spader/node-whisper-cpp-${TRIPLE}"
              npm publish "$TARBALL" --access public
            fi
          done

      - name: Publish main package
        run: |
          TARBALL=$(find artifacts -name "node-whisper-cpp.tgz" -not -name "node-whisper-cpp-*" | head -1)
          echo "Publishing @spader/node-whisper-cpp"
          npm publish "$TARBALL" --access public
