name: build-single

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to build"
        required: true
        type: choice
        default: x64-linux-cpu-gnu
        options:
          - x64-linux-cpu-gnu
          - x64-linux-cuda-gnu
          - arm64-darwin-metal

permissions:
  contents: read

jobs:
  build-cpu:
    if: ${{ inputs.target == 'x64-linux-cpu-gnu' }}
    runs-on: ubuntu-22.04
    env:
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache
      SCCACHE_CACHE_SIZE: 4G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build target
        uses: ./.github/actions/build-target
        with:
          triple: x64-linux-cpu-gnu
          backend: cpu
          smoke: "true"

  build-cuda:
    if: ${{ inputs.target == 'x64-linux-cuda-gnu' }}
    runs-on: ubuntu-22.04
    env:
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache
      SCCACHE_CACHE_SIZE: 4G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build target
        uses: ./.github/actions/build-target
        with:
          triple: x64-linux-cuda-gnu
          backend: cuda
          cuda: "12.6.3"
          smoke: "false"

  build-metal:
    if: ${{ inputs.target == 'arm64-darwin-metal' }}
    runs-on: macos-26
    env:
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache
      SCCACHE_CACHE_SIZE: 4G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build target
        uses: ./.github/actions/build-target
        with:
          triple: arm64-darwin-metal
          backend: metal
          smoke: "false"
